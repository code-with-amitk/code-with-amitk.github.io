<!DOCTYPE html>
<html>
  <head>
    <title>Facebook News Feed</title>
    <link rel="stylesheet" href="/css/styles.css"/>
    <link rel="stylesheet" href="/css/prism.css"/>
  </head>

<body>
  <nav class="navbar">    <!--See .navbar in styles.css-->
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="#">Our team</a></li>
      <li><a href="#">Projects</a></li>
      <li><a href="/contact.html">Contact</a></li>
      <li>
        <form id="searchForm">
            <input type="search" id="searchInput" name="q" placeholder="Search site" />
            <input type="submit" value="Go!" />
        </form>
        </li>
    </ul>
  </nav>

  <aside class="sidebar">
    <a href="#req">Requirements</a>
    <a href="#boe">Back of Envelope</a>
    <a href="#api">API Design</a>
    <a href="#db">DB Schema</a>
    <ul>
      <li><a href="#sql">SQL DB</a></li>
      <ul>
        <li><a href="#problemsind1">Problems in Above design</a></li>
        <ul>
          <li><a href="#redis">Sol1=Redis</a></li>
          <li><a href="#neoj4">Sol2=neoj4</a></li>
        </ul>
      </ul>
    </ul>
  </aside>

  <article style="margin-left:200px;">
    <h2 id="req">Requirements (CRUD)</h2>
    <h4>Functional</h4>
    <dl id="func-req">
      1. User can Read the feed.<br>
      2. User can Create the feed(images, text, videos)
    </dl>
    <h4>Non Functional</h4>
    <dl>
      1. Update the feed<br>
      2. Delete the item from feed<br>
      3. News feed keep on extending when it gets over
    </dl>

    <h2 id="boe">Back of Envelope</h2>
    <pre>
      World Population      | InternetUsers(60%)    | FB Users(80-85% of Internet users) | Active FB Users(20%)
      ----------------------|-----------------------|------------------------------------|--------------------
      7 Billion //Year 2020 | 7 x 0.6 = 4.2 Billion |    4.2 x 0.8 = 3.5 Billion         | 3.5 x .2 = 700 Million
    </pre>
    <h4 id="traffic">Traffic Estimates (Incoming Requests/sec)</h4>
    <pre>
      700 Million pulling their new feed 5 times a day. Total New feed requests = 700 x 5 = 3500 Million requests/day.
      3500/24x60x60 = Around 39,000 Requests/sec.
    </pre>
    <h4 id="storage">Storage Estimates</h4>
    <pre>
      <b>Cache/CDN</b>
      Suppose We want to keep 500 posts/user on CDN for quick fetch.
      Total posts to be stored. 500 x 700 Million = 350 Billion.
      Let's assume on average each posts is 1 KB in size. Total bytes = 350 TB
      Assuming 1 server can cache is 100GB. Total servers needed = 350 TB / 100 GB = 3500 Machines needed in total
    </pre>

    <h2 id="api">API Design</h2>
      <h4 id="#func-req">1. Create Record</h4>
      <pre><code class="language-css">
POST https://url/v1/post_feed
header {
    Authorization: {Bearer "API_KEY_TOKEN"},
}
body {
    heading, description, picture_url, video_url
}
      </code></pre>

      <h4 id="#func-req">2. Reading the Feed</h4>
      <pre><code class="language-css">
GET HTTP/2 https://url/v1/read_feed
header {
    Authorization: {Bearer "API_KEY_TOKEN"},
}
body {
    to be filled
}
      </code></pre>

      <h2 id="db">DB Schema</h2>
      <h4 id="sql">SQL DB</h4>
      <pre>
      User information, password, comments can be stored in seperate tables.
      Likes to Comments can be stored in seperate table and comments table can store like_id.
      </pre>

      <pre><code class="language-css">
User Table                                                    Password Table
| username | user_id(pk) | created_at | enabled |             | user_id(pk) | password_hash | created_at | expiry_at |

Comments Table: Comment can have text,video,image,@,#,likes,shares
| comment_id (pk) | text_id(fk) | user_id (fk) | media-id(fk) | created_at | like_id(fk) | share_id(fk) | ...
      id1                t1           u1            m1              -             l1          s1

Text Table                                likes Table                                               Media Table (Photo, text, video)
| key=text_id (pk) | value=text url |     | key=like_id (pk) | value=file url storing all likes |   | key=text_id (pk) | value=text url |
        t1              hello                   l1                (user2, user3, user4 ..)
      </code></pre>

      <h5 id="problemsind1">Problems in Above design (likes table)</h5>
      <dl>1. Race Condition, when number of likes on comment grows in Millions</dl>
      <dd>We will keep appending userid's on in same file (ie same row). if new like comes in DB has to read entire line
        then add userid at end and update table.<br>
        This can cause race condition (if 100's of users try to like same comment at same time).
      </dd>

      <h6 id="redis">Solution-1 (Key-Value DB: Redis)</h6>
      <dl>
        Seperate row for each like. Key-Value DBs can handle huge datasets with fast lookups<br>
        Precomputing the number of likes.
      </dl>
      <pre><code class="language-css">
likes Table
SADD comment_id1 user1
SADD comment_id1 user2
SADD comment_id1 user3
SADD comment_id2 user2
SREM comment_id1 user2   # Unlike
SCARD comment:id1:likes        # Get like count
      </code></pre>

      <h6 id="neoj4">Solution-2 (Graph DB(neoj4))</h6>
      <dl>
        In a graph database, you can model User and Comment as nodes and the LIKES relationship as an edge.<br>
        Likes = Number of edges
      </dl>
      <pre><code class="language-css">
        user-1    ----authored-->     comment-1
                                        /\
        user2 ----------liked------------|
      </code></pre>

  </article>
  <script src="/scripts/prism.js"></script>
</body>
</html>
